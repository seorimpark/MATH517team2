---
title: "COVID--19 : Study about mortality in the US"
description: |
  Statistical computation and visualization (MATH-517)
date: October 26, 2021
author:
- name: "Zineb AGNAOU"  
  url: https://github.com/ZinebAg
- name: "Fahim BECK"
  url: https://github.com/FahimBeck
- name: "Salima JAOUA"
  url: https://github.com/salimajaoua
- name: "Matias JANVIN"
  url: https://github.com/matiasjanvin
- name: "Seorim PARK"
  url: https://github.com/seorimparkk
output: distill::distill_article
---
<style>
body {text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
-statement of problem/circumstance
-significance of problem
-purpose of study
-assumptions and limitations
-Review of preceding research and literature


*Salima*  

*Matias*  

### Approaches:
To answer the above questions, we will proceed as follows:
A descriptive and visual approach where we will produce interactive plots with information on number of deaths along different dimensions: geographically, temporally, by different risk factors. We will then proceed with the analysis of mortality rate as a function of time and based on different risk factors. Afterwards we switch to the correlation and spatial comparison studies: between two selected states, two neighbouring states or considering different levels of neighbourhoods through a separation analysis.

## Sources of information/ datasets:

In this project, several datasets were used to answer our questions. Each one of them refers to the same population (the US). Here are more specific descriptions. 

### US deaths within categories and states

The first dataset we use is about [provisional COVID--19 deaths by place of death and age](https://data.cdc.gov/NCHS/Provisional-COVID-19-Deaths-by-Place-of-Death-and-/4va6-ph5s) from the CDC in the US. A complete description of it is available on the web page. 

The variables we used in this project are : `Group`, `Year`, `Month`,	`HHS Region`,	`State`,	`Place of Death`, `Age group`, `COVID-19 Deaths` and `Total Deaths`. What is particular here is that the sum of `COVID-19 Deaths` is not the total number of deaths in the US. Actually, we need to filter our data by `Group`, `State`, `Place of Death` and `Age Group` in order to get what we want.

A last thing we should take into account is that those numbers of deaths are not the exact number that happened during a given period. The reason is that there is always a lag in time (usually 1 to 8 weeks) between the instant when the death occurred and between when the death certificate is completed and submitted for reporting purposes. 

### US deaths within categories and states

*Seorim*  

### Additional: US population, ...

*Seorim*  

## Packages

Here are some packages used in our project. Make sure they are installed before running the R Markdown file. Since the format of this Markdown is not standard, you need to install the *Distill* package. Instructions can be found on [Github](https://github.com/rstudio/distill).

````{r, message=FALSE}

library(readr)
library(dplyr) # Useful for reading variables containing spaces
library(ggplot2)
library(reshape)
library(stringr) # Labels overlap
library(scales) # Labels value format
library(usmap)

````



## Spatial exploration of Covid deaths in the United States over time:

In this subsection, we intend to visualize our data before starting different analyses. 
To do so, we display the number of deaths on the United States map shown in Figures 1, 2, 3 and 4. 
The Plotted Data represent the deaths per 1 million individuals, we standardise the data according to the population of each state.


````{r, include=FALSE}
# data :

df0<- read_csv("Data/Data_us_interactive_us_map.csv")
df1<- df0[,-c(1,17)]
# transforming the columns start date and end date to date format:
df3<-df1
df3$`Start Date`<- as.Date(df3$`Start Date`, format="%m/%d/%Y")
df3
df3$`End Date`<- as.Date(df3$`End Date`, format="%m/%d/%Y")
df3
#transform the other columns ( "Group","HHS Region","State","Place of Death" "Age group") into factors:
df4<-df3
#col_names <- colnames(df4[,4:10])
#df4[col_names] <- lapply(df4[col_names] , factor)
data_interactive<-df4
data_interactive<-as.data.frame(data_interactive)


us_popul<-statepop 
````

```{r,, include=FALSE}
# functions I need: 
Select_Age_Group<-function(DataFrame, agegroup)
{ 
  age_groups<-unique(DataFrame$`Age group`)
  if(agegroup %in% age_groups)
  {
    df1= DataFrame %>% filter(`Age group` == agegroup )
    df1<-as.data.frame(df1)
    return(df1)
  }
  else{
    warning("Age group selected not in the list, the returned dataframe has not been filtered")
    return (DataFrame)
  }
}

Select_Group<-function(DataFrame, group)
{ 
  all_groups<-unique(DataFrame$`Group`)
  if(group %in% all_groups)
  {
    df1= DataFrame %>% filter(`Group` == group )
    df1<-as.data.frame(df1)
    return(df1)
  }
  else{
    warning("Group selected not in the list, the returned dataframe has not been filtered")
    return (DataFrame)
  }
}

Select_HHSRegion<-function(DataFrame, region)
{ 
  all_regions<-unique(DataFrame$`HHS Region`)
  if(region %in% all_regions)
  {
    df1= DataFrame %>% filter(`HHS Region` == region )
    df1<-as.data.frame(df1)
    return(df1)
  }
  else{
    warning("HHS Region selected not in the list, the returned dataframe has not been filtered")
    return (DataFrame)
  }
}


Select_State<-function(DataFrame, state)
{ 
  all_states<-unique(DataFrame$State)
  if(state %in% all_states)
  {
    df1= DataFrame %>% filter(`State` == state )
    df1<-as.data.frame(df1)
    return(df1)
  }
  else{
    warning("State selected not in the list, the returned dataframe has not been filtered")
    return (DataFrame)
  }
}


Select_PlaceDeath<-function(DataFrame, place_d)
{ 
  all_places<-unique(DataFrame$`Place of Death`)
  if(place_d %in% all_places)
  {
    df1= DataFrame %>% filter(`Place of Death` == place_d )
    df1<-as.data.frame(df1)
    
    return(df1)
  }
  else{
    warning("Place of death selected not in the list, the returned dataframe has not been filtered")
    return (DataFrame)
  }
}

Select_all<-function(DataFrame, agegroup,place_d,group, m, y)
{
  # I want to use %>% but not quite confortable, I ll use brute force first:
  df1=Select_Age_Group(DataFrame,agegroup)
  df2=Select_PlaceDeath(df1,place_d)
  df3=df2 %>% filter(`Group` == group )
  if(group=="By Total")
  {return(as.data.frame(df3))}
  else if(group=="By Year") 
  {
    df4=df3 %>% filter(`Year` == y )
    return(as.data.frame(df4))
  }
  else if(group=="By Month")
  {
    df4=df3 %>% filter(`Year` == y )
    df5=df4 %>% filter(`Month` == m )
    return(as.data.frame(df5))
  }
  
  
}


standardise_pop<-function(data)
{
  data[,2]=data[,2]*1000000/us_popul$pop_2015
  data<-as.data.frame(data)
  return(data)
}


data_to_plot<-function(DataFrame, agegroup,place_d,group, m, y){

  df_to_plot<-Select_all(DataFrame, agegroup,place_d,group, m, y)
  Death_by_state<-df_to_plot %>% 
            group_by(State) %>% 
            summarise(`COVID-19 Deaths`= sum(`COVID-19 Deaths`,na.rm=TRUE))
  
  Death_by_state<-Death_by_state[-c(34,41,47),]
  Death_by_state<-standardise_pop(Death_by_state)
  
  Total_D<-Death_by_state$`COVID-19 Deaths`
  us_TotalD<-as.data.frame(us_popul)
  us_TotalD$pop_2015<-Total_D
  us_TotalD<-us_TotalD[,-c(1,2)]
  colnames(us_TotalD)[1]<-"state"
  us_TotalD<-as.data.frame(us_TotalD)
  return(us_TotalD)}
```

```{r, include=FALSE}
# data plots
dt1<-data_to_plot(data_interactive,"All Ages","Total - All Places of Death","By Month",7,2020)
dt2<-data_to_plot(data_interactive,"All Ages","Total - All Places of Death","By Month",12,2020)
dt3<-data_to_plot(data_interactive,"0-17 years","Total - All Places of Death","By Total",0,0)
dt4<-data_to_plot(data_interactive,"85 years and over","Total - All Places of Death","By Total",0,0)
        

```

```{r,include=FALSE}
print(c(mean(dt1$pop_2015),mean(dt2$pop_2015),mean(dt3$pop_2015),mean(dt4$pop_2015)))
```
Figure (1) represents deaths of people regardless of their age as of July 2020. Figure (2) represents the deaths of people of all ages in July. 
We notice the growth in the number of deaths: 300 out of 1 million people in Arizona at the peak in July with an average of 70.05 across the country. In December 2020, we note an increase in mortality to over 500 deaths per million inhabitants in Colorado and North Dakota, along with a countrywide average of 310.32. 

Figure (3) shows the total number of deaths over the entire two-year period for individuals aged 0-17 years. The average number of deaths nationally is 0.62 per 1 million inhabitants with a maximum value of 3.07 in Arizona. Figure (4) shows the total number of deaths over the two years for persons over 85 years of age. The average death rate rises to 576.24 deaths per million population with a maximum of 1158.76 in Rhode Island and a minimum of 117.35 in Hawaii. The examples chosen in this section are rather extreme and are meant to better visualize the data and discover interesting trends or factors to analyze later in this project.

```{r, echo=FALSE}
plot_usmap(data=dt1, values = "pop_2015",labels = TRUE, color = "red") + 
          scale_fill_continuous(name = "Corona deaths in the USA per million ", low="lightpink",high="Red",label = scales::comma) +labs(title = "  Figure (1): deaths per million in July 2020 for all age groups accross the United States.")+
          theme(legend.position = "right")
```

                      
```{r, echo=FALSE}
par(mfrow=c(1,1))
plot_usmap(data=dt2, values = "pop_2015",labels = TRUE, color = "red") + 
          scale_fill_continuous(name = "Corona deaths in the USA per million ", low="lightpink",high="Red",label = scales::comma) +labs(title = "  Figure (2): deaths per million in December 2020 for all age groups accross the United States. ")+
          theme(legend.position = "right" ) 
```

```{r, echo=FALSE}
plot_usmap(data=dt3, values = "pop_2015",labels = TRUE, color = "red") + 
          scale_fill_continuous(name = "Corona deaths in the USA per million ", low="lightpink",high="Red",label = scales::comma) + labs(title = "Figure (3): total deaths per million in 2020 and 2021 for individual aged between 0 and 17 years old accross the United States.")+
          theme(legend.position = "right")
```

```{r, echo=FALSE}
plot_usmap(data=dt4, values = "pop_2015",labels = TRUE, color = "red") + 
          scale_fill_continuous(name = "Corona deaths in the USA per million ", low="lightpink",high="Red",label = scales::comma) + labs(title = "Figure (4): total deaths per million in 2020 and 2021 for individual aged 85+ years old accross the United States. ")+
          theme(legend.position = "right")
```
        
An interactive version is available under this [link](https://zinebag.shinyapps.io/InteractiveGeographicMapShiny/). You can select which map to display based on time period, age range and place of death.        

## Risk factors 

In this section, we will have a closer look at the risk factors of death from COVID--19. More particularly, we will first consider age and second the place where death occured.  

````{r, include=FALSE}

data = read_csv("Data/Provisional_COVID-19_Deaths_by_Place_of_Death_and_Age.csv")

head(data)
colnames(data)

# Taking away useless variables
data = data[,-c(1,2,3,5,6,14,16,17)]
colnames(data)

# Looking at values taken by certain variables
unique(data$`Age group`)
unique(data$State)
unique(data$Group)
unique(data$`Place of Death`)

####### Comparing age and nb of deaths #######

# Filtering, deleting and ordering columns
age = filter(data, `Age group` != "All Ages" & State == "United States" 
               & Group == "By Total" & `Place of Death` == "Total - All Places of Death") 

# Verifying `HHS Region`==0 before deleting
unique(age$`HHS Region`)

# Taking only age group and covid deaths
age = subset(age, select=c(`Age group`, `COVID-19 Deaths`))

# Converting to frame
colnames(age)
dim(age)
age = data.frame(age)
age

````

### Age group

Here are deaths per age group since the beginning of the pandemic.

````{r, echo=FALSE}

# Barplot
ggplot(data=age, aes(x=Age.group, y=COVID.19.Deaths, fill=COVID.19.Deaths)) + 
  geom_bar(stat="identity") +
  scale_fill_gradient(low="cyan", high="blue", name = NULL) +
  ggtitle("Covid deaths per age group") +
  theme(plot.title = element_text(size=16, hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = 'Age group', y = 'Deaths') +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  scale_y_continuous(labels = format_format(big.mark = " ", decimal.mark = ",", 
                                            scientific = FALSE))

````

Older people are those who died the most as expected. The same barplot is available by month in an interactive web app. You can access it by clicking [here](https://fahimbeck.shinyapps.io/barplot_app/). By moving the slider, we are always able to observe a right-increase tendency on the barplots. We are also able to identify each wave. 

### Place of death

````{r, include=FALSE}

####### Comparing places and causes #######

# Filtering, deleting and ordering columns
place = filter(data, `Age group` == "All Ages" & State == "United States" 
             & Group == "By Total" & `Place of Death` != "Total - All Places of Death") 

# Verifying `HHS Region`==0 before deleting
unique(place$`HHS Region`)

# Taking only age group and covid deaths
place = subset(place, select=c(`Place of Death`, `COVID-19 Deaths`))

# Converting to frame
colnames(place)
dim(place)
place = data.frame(place)
place

````

Here are deaths per place of death since the beginning of the pandemic.

````{r, echo=FALSE}

# Barplot
ggplot(data=place, aes(x=reorder(Place.of.Death, COVID.19.Deaths), y=COVID.19.Deaths)) + 
  geom_bar(stat="identity", fill='steelblue') +
  coord_flip() +
  ggtitle("Covid deaths per place of death") +
  theme(plot.title = element_text(size=16, hjust = 0.5)) +
  theme(axis.text.x = element_text(face="bold", color="black",size=8, angle=0),
        axis.text.y = element_text(face="bold", color="black",size=8, angle=0)) + 
  labs(x = NULL, y = 'deaths') +  
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  scale_y_continuous(labels = format_format(big.mark = " ", decimal.mark = ",", 
                                            scientific = FALSE))

````

Here we can clearly see that most people were inpatients in a healthcare setting before dying. This includes ICUs and reflects our expectations. Then, people in nursing homes died also a lot as expected (older people being at risk), but much less than the previous category. 

## Mortality rate through time 

*Salima*

## Impact of geolocation on cases and deaths from COVID--19

### Correlations depending of neighboorship

*Seorim*

### Correlations depending of degrees of separation

*Matias*

## Conclusion 

*pending*

## Future improvements 

*pending*



